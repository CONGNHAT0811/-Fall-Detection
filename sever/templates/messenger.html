{% extends "main.html" %}
{% block title %}Th√¥ng B√°o{% endblock %}
{% block cont %}
<main class="flex-1 p-4 md:p-6 overflow-y-auto scrollbar-custom">
    <div id="notifySection" class="content-section">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
            <span>üîî</span> Th√¥ng tin th√¥ng b√°o
        </h2>
        {% if error %}
        <div class="error-message bg-red-50 p-4 rounded-lg shadow text-red-600 mb-4">{{ error }}</div>
        {% endif %}
        <div class="bg-white rounded-xl shadow-md p-6 notify-container">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <div class="info-item">
                        <p class="text-sm font-semibold text-gray-700">‚ö†Ô∏è Tr·∫°ng Th√°i</p>
                        <p id="status" class="text-base text-red-600 bg-red-50 p-2 rounded-lg">Ch∆∞a c√≥ ph√°t hi·ªán</p>
                    </div>
                    <div class="info-item">
                        <p class="text-sm font-semibold text-gray-700">üìä T·ªâ L·ªá</p>
                        <p id="probability" class="text-base text-blue-600 bg-blue-50 p-2 rounded-lg">0%</p>
                    </div>
                    <div class="info-item">
                        <p class="text-sm font-semibold text-gray-700">üïí Th·ªùi Gian</p>
                        <p id="timestamp" class="text-base bg-gray-100 p-2 rounded-lg">Ch∆∞a c√≥</p>
                    </div>
                    <div class="info-item">
                        <p class="text-sm font-semibold text-gray-700">üìç V·ªã tr√≠</p>
                        <p id="locationElement" class="text-base bg-gray-100 p-2 rounded-lg">Ch∆∞a c√≥</p>
                    </div>
                </div>
                <div class="info-item">
                    <p class="text-sm font-semibold text-gray-700">üì∏ H√¨nh ·∫¢nh</p>
                    <img id="detectionImage" src="https://via.placeholder.com/320x180?text=Chua+Co+Anh"
                        class="rounded-lg border shadow w-full h-auto" />
                </div>
            </div>
        </div>
    </div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
<script>
    // G·ª≠i y√™u c·∫ßu chuy·ªÉn sang ch·∫ø ƒë·ªô detection
    fetch('/api/set_mode', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'mode=detection'
    })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('ESP32 set to detection mode');
            } else {
                console.error('Failed to set detection mode:', data.error);
                alert('L·ªói: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error setting detection mode:', error);
            alert('L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi v·ªõi ESP32');
        });

    // SocketIO cho c·∫≠p nh·∫≠t real-time
    const socket = io('http://' + window.location.host);
    socket.on('new_detection', (data) => {
        try {
            document.getElementById('status').textContent = data.status || 'Ch∆∞a c√≥ ph√°t hi·ªán';
            document.getElementById('probability').textContent = data.probability || '0%';
            document.getElementById('timestamp').textContent = data.timestamp || 'Ch∆∞a c√≥';
            document.getElementById('locationElement').textContent = data.location || 'Ch∆∞a c√≥';
            document.getElementById('detectionImage').src = data.image_path || 'https://via.placeholder.com/320x180?text=Chua+Co+Anh';
            if (data.status === 'Ng√£') {
                fetch('/static/audio/alert.mp3')
                    .then(response => {
                        if (response.ok) {
                            new Audio('/static/audio/alert.mp3').play();
                        } else {
                            console.warn('Alert audio not found');
                        }
                    })
                    .catch(error => console.error('Error playing audio:', error));
                alert(`C·∫£nh b√°o: Ph√°t hi·ªán ng√£ t·∫°i ${data.location} (${data.timestamp})!`);
            }
        } catch (error) {
            console.error('L·ªói SocketIO:', error);
        }
    });
    socket.on('connect_error', () => {
        document.getElementById('status').textContent = 'L·ªói: M·∫•t k·∫øt n·ªëi server';
    });
</script>
{% endblock %}