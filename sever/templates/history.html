{% extends "main.html" %}
{% block title %}L·ªãch s·ª≠ ph√°t hi·ªán{% endblock %}
{% block cont %}
<main class="flex-1 p-4 md:p-6 overflow-y-auto scrollbar-custom">
    <div class="content-section">
        <h2 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
            <span>üìú</span> L·ªãch s·ª≠ ph√°t hi·ªán
        </h2>
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm..." class="p-2 border rounded w-full mb-4" />
        <div id="loading" class="text-center text-gray-600">ƒêang t·∫£i...</div>
        <ul id="historyList" class="space-y-4 hidden"></ul>
    </div>
</main>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js" async></script>
<script>
    const socket = io('http://' + window.location.host);
    let historyData = [];

    async function loadHistory() {
        const list = document.getElementById('historyList');
        const loading = document.getElementById('loading');
        try {
            const res = await fetch('/api/history');
            if (!res.ok) throw new Error('L·ªói khi l·∫•y d·ªØ li·ªáu: ' + res.status);
            const data = await res.json();
            if (data.error) throw new Error(data.error);
            historyData = data;
            loading.classList.add('hidden');
            list.classList.remove('hidden');
            displayHistory(historyData);
        } catch (error) {
            console.error('L·ªói:', error);
            list.innerHTML = '<li class="bg-red-50 p-4 rounded-lg shadow text-red-600">L·ªói: Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠</li>';
            loading.classList.add('hidden');
            list.classList.remove('hidden');
        }
    }

    function displayHistory(data) {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if (data.length === 0) {
            list.innerHTML = '<li class="bg-gray-50 p-4 rounded-lg shadow text-gray-600">Kh√¥ng c√≥ d·ªØ li·ªáu</li>';
            return;
        }
        data.forEach(entry => {
            const li = document.createElement('li');
            li.className = 'bg-white p-4 rounded-lg shadow';
            li.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p><strong>üïí Th·ªùi gian:</strong> ${entry.timestamp || 'Ch∆∞a c√≥'}</p>
                        <p><strong>üìç V·ªã tr√≠:</strong> ${entry.location || 'Ch∆∞a c√≥'}</p>
                        <p><strong>‚ö†Ô∏è Tr·∫°ng th√°i:</strong> ${entry.status || 'Ch∆∞a c√≥'}</p>
                        <p><strong>üìä X√°c su·∫•t:</strong> ${entry.probability || '0%'}</p>
                    </div>
                    <div>
                        <img src="${entry.image_path || 'https://via.placeholder.com/320x180?text=Chua+Co+Anh'}" 
                             class="rounded-lg border shadow w-full max-w-xs h-auto object-cover" 
                             alt="H√¨nh ·∫£nh ph√°t hi·ªán" 
                             onerror="this.src='https://via.placeholder.com/320x180?text=Anh+Bi+Loi';" />
                    </div>
                </div>
            `;
            list.appendChild(li);
        });
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = historyData.filter(entry =>
            (entry.timestamp || '').toLowerCase().includes(keyword) ||
            (entry.location || '').toLowerCase().includes(keyword) ||
            (entry.status || '').toLowerCase().includes(keyword)
        );
        displayHistory(filtered);
    });

    socket.on('new_detection', (data) => {
        historyData.unshift(data);
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        if (!searchInput ||
            data.timestamp.toLowerCase().includes(searchInput) ||
            data.location.toLowerCase().includes(searchInput) ||
            data.status.toLowerCase().includes(searchInput)) {
            displayHistory(historyData);
        }
    });

    loadHistory();
</script>
{% endblock %}